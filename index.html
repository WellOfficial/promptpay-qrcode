<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My PromptPay QR</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; overscroll-behavior-y: none; }
        input, button { touch-action: manipulation; }
        
        /* Animation Styles */
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-card { animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes scanMove { 
            0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } 
        }
        .scanner-line {
            position: absolute; width: 100%; height: 2px; background: #60a5fa;
            box-shadow: 0 0 8px #60a5fa, 0 0 15px #3b82f6;
            animation: scanMove 2s infinite linear; left: 0; z-index: 10; pointer-events: none;
        }

        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .qr-pop { animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .neon-box { box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
    </style>
    <script> tailwind.config = { darkMode: 'class' } </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-950 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-800 via-gray-900 to-black select-none">

    <div class="animate-card bg-gray-800/80 backdrop-blur-md w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-gray-700/50">
        <div class="relative bg-gradient-to-r from-blue-900/80 to-slate-900/80 p-6 text-center border-b border-gray-700">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-70"></div>
            <h1 class="text-xl font-medium text-white tracking-wider uppercase">Quick Receive</h1>
            <p class="text-blue-300/70 text-xs mt-1 font-light">PromptPay Generator</p>
        </div>

        <div class="p-6 space-y-6">
            <div class="group">
                <label class="block text-gray-400 text-xs font-light mb-2 ml-1">YOUR ID</label>
                <input type="tel" id="pp-id" placeholder="08x-xxx-xxxx" 
                    class="w-full px-4 py-3 rounded-xl bg-gray-900/50 border border-gray-600 text-gray-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 focus:bg-gray-900 focus:outline-none transition-all duration-300 text-base font-light tracking-wide"
                    oninput="validateAndGenerate()">
            </div>

            <div class="group">
                <label class="block text-gray-400 text-xs font-light mb-2 ml-1">AMOUNT (THB)</label>
                <div class="relative">
                    <input type="number" id="pp-amount" placeholder="0.00" inputmode="decimal"
                        class="w-full px-4 py-3 rounded-xl bg-gray-900/50 border border-gray-600 text-blue-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 focus:bg-gray-900 focus:outline-none transition-all duration-300 text-xl font-medium"
                        oninput="validateAndGenerate()"> 
                </div>
            </div>

            <div class="h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent w-full"></div>

            <div class="flex flex-col items-center justify-center min-h-[260px]">
                <div id="qrcode-container" class="relative p-4 bg-white rounded-xl shadow-lg neon-box hidden qr-pop">
                    <div class="scanner-line"></div> 
                    <div id="qrcode"></div>
                    <div class="text-center mt-2 text-[10px] text-gray-400 font-mono tracking-widest">SCAN TO PAY</div>
                </div>
                
                <div id="placeholder" class="text-gray-600/50 text-center py-8 flex flex-col items-center transition-opacity duration-500">
                    <div class="w-16 h-16 rounded-full border-2 border-dashed border-gray-700 flex items-center justify-center mb-3 animate-spin-slow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                        </svg>
                    </div>
                    <span class="text-xs font-light tracking-wide">Ready to Generate</span>
                </div>
                
                <button id="download-btn" onclick="downloadQR()" class="hidden mt-6 w-full bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 border border-blue-500/30 font-medium py-3 px-4 rounded-xl transition-all duration-300 active:scale-95 flex items-center justify-center gap-2 text-sm backdrop-blur-sm group">
                    <span>Save Image</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(() => console.log('Service Worker Registered'))
            .catch(error => console.log('SW Registration Failed:', error));
        }

        // --- PromptPay Logic ---
        function crc16(data) {
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xFF;
                x ^= x >> 4;
                crc = ((crc << 8) ^ (x << 12) ^ (x << 5) ^ x) & 0xFFFF;
            }
            return crc.toString(16).toUpperCase().padStart(4, '0');
        }

        function generatePayload(target, amount) {
            target = target.replace(/[^0-9]/g, '');
            let targetType = '';
            if (target.length === 10 && target.startsWith('0')) {
                targetType = '01'; target = '0066' + target.substring(1); 
            } else if (target.length === 13) { targetType = '02'; } else { return null; }

            let fAmount = '';
            if (amount) { fAmount = parseFloat(amount).toFixed(2); }

            const data = [ '000201', amount ? '010212' : '010211', '2937', '0016A000000677010111', targetType + String(target.length).padStart(2, '0') + target, '5802TH', '5303764' ];
            if (fAmount) { data.push('54' + String(fAmount.length).padStart(2, '0') + fAmount); }

            let payload = data.join('') + '6304';
            payload += crc16(payload); 
            return payload;
        }

        const ppIdInput = document.getElementById('pp-id');
        const ppAmountInput = document.getElementById('pp-amount');
        const qrContainer = document.getElementById('qrcode-container');
        const placeholder = document.getElementById('placeholder');
        const qrDiv = document.getElementById('qrcode');
        const downloadBtn = document.getElementById('download-btn');

        window.onload = function() {
            const savedId = localStorage.getItem('my_promptpay_id_neon');
            if (savedId) { ppIdInput.value = savedId; validateAndGenerate(); }
        };

        function validateAndGenerate() {
            const id = ppIdInput.value.trim();
            const amount = ppAmountInput.value.trim();
            localStorage.setItem('my_promptpay_id_neon', id);
            const payload = generatePayload(id, amount);
            qrDiv.innerHTML = ""; 

            if (payload) {
                qrContainer.classList.remove('hidden');
                qrContainer.classList.remove('qr-pop');
                void qrContainer.offsetWidth; 
                qrContainer.classList.add('qr-pop');
                downloadBtn.classList.remove('hidden');
                placeholder.classList.add('hidden');
                new QRCode(qrDiv, { text: payload, width: 200, height: 200, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.L });
            } else {
                qrContainer.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function downloadQR() {
            const img = qrDiv.querySelector('img');
            if (img && img.src) {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `PromptPay_${ppAmountInput.value || 'QR'}.png`;
                link.click();
            }
        }
    </script>
</body>
</html>